{% extends 'base.html' %}

{% block title %}Carrito de Ventas{% endblock %}

{% block content %}
<!-- Meta para incluir el turno_id en el script -->
<meta name="turno-id" content="{{ turno.id }}">
<meta name="eliminar-item-url" content="{% url 'ventas:eliminar_item_carrito' %}">

<div class="container mt-4">
    <h1>Carrito de Ventas</h1>

    {% if carrito_items %}
        <!-- Contenedor para mensajes -->
        <div id="mensaje" class="mt-2"></div>

        <!-- Tabla para mostrar el carrito -->
        <div class="table-responsive">
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in carrito_items %}
                        <tr id="item-{{ item.id }}">
                            <td>{{ item.producto.nombre }}</td>
                            <td>
                                <input type="number" class="form-control cantidad-item"
                                id="cantidad-{{ item.id }}" name="cantidad_{{ item.id }}"
                                data-item-id="{{ item.id }}" value="{{ item.cantidad }}" min="1" style="width: 70px;">                         
                            </td>
                            <td>{{ item.producto.precio }} {{ item.producto.moneda }}</td>
                            <td id="subtotal-{{ item.id }}">{{ item.subtotal }} {{ item.producto.moneda }}</td>
                            <td>
                                <!-- Bot√≥n para eliminar el producto -->
                                <button type="button" class="btn btn-danger btn-sm eliminar-item"
                                        data-item-id="{{ item.id }}">
                                    <i class="fas fa-trash-alt"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mostrar el total -->
        <p class="font-weight-bold text-right" style="font-size: 1.5em;">
            Total: <span id="total">{{ total }} {{ carrito_items.0.producto.moneda }}</span>
        </p>
    {% else %}
        <p>El carrito est√° vac√≠o. ¬°Agrega productos al carrito!</p>
    {% endif %}
        
    <!-- Bot√≥n para agregar productos al carrito -->
    <div class="d-flex justify-content-between">
        <a href="{% url 'ventas:inicio_turno' turno.id %}" class="btn btn-secondary">
            <i class="fas fa-plus"></i> Agregar Productos al Carrito
        </a>

        <!-- Botones de cotizaci√≥n y facturaci√≥n solo si hay productos en el carrito -->
        {% if carrito_items %}
            <div class="btn-group" role="group">
                {% if cotizacion %}
                    <a href="{% url 'facturacion:generar_pdf_cotizacion' cotizacion.id %}" class="btn btn-primary">
                        <i class="fas fa-file-alt"></i> Generar Cotizaci√≥n
                    </a>
                {% else %}
                    <a href="#" class="btn btn-primary disabled">
                        <i class="fas fa-file-alt"></i> Generar Cotizaci√≥n
                    </a>
                {% endif %}
                <a href="{% url 'facturacion:generar_factura' %}" class="btn btn-success">
                    <i class="fas fa-file-invoice-dollar"></i> Generar Factura
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- Scripts -->
{% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ Script de carrito cargado correctamente.");
    
        const eliminarItemUrl = document.querySelector('meta[name="eliminar-item-url"]').content;
    
        function agregarEventosEliminar() {
            const botonesEliminar = document.querySelectorAll(".eliminar-item");
    
            console.log(`üîç Se encontraron ${botonesEliminar.length} botones de eliminar.`);
    
            botonesEliminar.forEach(button => {
                const itemId = button.dataset.itemId;
                console.log(`üîπ Registrando evento para bot√≥n con item-id=${itemId}`);
    
                // Eliminar cualquier evento previo para evitar duplicados
                button.removeEventListener("click", eliminarProducto);
    
                // Agregar el evento "click"
                button.addEventListener("click", eliminarProducto);
            });
        }
    
        function eliminarProducto(event) {
            event.preventDefault();
    
            // Obtener datos del producto
            const itemId = this.dataset.itemId;
            const turnoId = document.querySelector('meta[name="turno-id"]').content;
    
            console.log(`üõë Click detectado en el bot√≥n. Enviando datos: item_id=${itemId}, turno_id=${turnoId}`);
    
            if (!itemId || !turnoId) {
                console.error("‚ùå Error: item_id o turno_id son inv√°lidos.");
                alert("Error: No se pudo obtener la informaci√≥n del producto.");
                return;
            }
    
            // Enviar la solicitud AJAX
            console.log(`üì° Enviando solicitud a URL: ${eliminarItemUrl}`);
            fetch(eliminarItemUrl, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.cookie.split("csrftoken=")[1].split(";")[0],
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    "item_id": itemId,
                    "turno_id": turnoId
                })
            })
            .then(response => {
                console.log("üîÑ Procesando respuesta...");
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ Respuesta del servidor:", data);
    
                if (data.success) {
                    console.log("‚úÖ Producto eliminado con √©xito.");
                    document.getElementById(`item-${itemId}`).remove();
                    document.getElementById("total").textContent = data.total + " {{ carrito_items.0.producto.moneda }}";
                } else {
                    console.error("‚ùå Error del servidor al eliminar el producto:", data.error);
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                console.error("‚ùå Error en la petici√≥n AJAX:", error);
                alert("Hubo un error al eliminar el producto.");
            });
        }
    
        // Llamar a la funci√≥n para registrar los eventos
        agregarEventosEliminar();
    
        // Verificar din√°micamente si se registraron eventos
        console.log("üß™ Verificando botones con eventos:");
        document.querySelectorAll(".eliminar-item").forEach(button => {
            const hasEvent = button.hasAttribute("data-event-registered");
            console.log(`üîπ Bot√≥n con item-id=${button.dataset.itemId}, Evento registrado: ${hasEvent}`);
        });
    });    
</script>
{% endblock %}